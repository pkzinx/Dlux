{% extends 'base.html' %}
{% block title %}Agendamentos{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Agendamentos</h3>
  <div>
    <a href="#" class="btn btn-sm btn-accent" data-bs-toggle="modal" data-bs-target="#quickScheduleModal">Novo agendamento</a>
    <a href="?export=csv" class="btn btn-sm btn-outline-light ms-2">Exportar CSV</a>
  </div>
  </div>

<div class="card card-panel mb-4">
  <div class="card-header fw-semibold">Agendamentos (histórico)</div>
  <div class="card-body p-0">
    <table class="table table-dark table-striped mb-0">
      <thead>
        <tr>
          <th style="width: 140px;">Data</th>
          <th style="width: 80px;">Hora</th>
          {% if is_admin %}<th>Barbeiro</th>{% endif %}
          <th>Cliente</th>
          <th>Telefone</th>
          <th>Serviço</th>
          {% if is_admin %}<th style="width: 140px;">Agendado em</th>{% endif %}
          <th style="width: 140px;">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for a in appointments_page %}
        <tr>
          <td>{{ a.start_datetime|date:'d/m/Y' }}</td>
          <td>{{ a.start_datetime|date:'H:i' }}</td>
          {% if is_admin %}<td>{{ a.barber.display_name|default:a.barber.username }}</td>{% endif %}
          <td>{{ a.client_name }}</td>
          <td>
            {{ a.client_phone }}
            {% if a.client_phone %}
              <a href="https://wa.me/{{ a.client_phone }}" target="_blank" class="ms-2" title="WhatsApp">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.78 11.78 0 0 0 3.47 20.52L2 22l1.56-.41A11.78 11.78 0 0 0 12 23.78 11.78 11.78 0 0 0 23.78 12 11.76 11.76 0 0 0 20.52 3.48zm-8.5 18.2a9.96 9.96 0 0 1-5.08-1.39l-.36-.21-3 .78.8-2.94-.23-.38a10 10 0 1 1 18.36-5.07 10 10 0 0 1-10.49 9.21zm5.71-7.53c-.31-.16-1.81-.89-2.09-.99s-.48-.15-.68.16-.78.99-.95 1.2-.35.23-.66.08a8.2 8.2 0 0 1-2.41-1.49 9.09 9.09 0 0 1-1.64-2.03c-.17-.31 0-.48.13-.64s.31-.38.46-.58.21-.31.32-.52.05-.39-.02-.55-.68-1.64-.93-2.24-.49-.52-.67-.53h-.57a1.1 1.1 0 0 0-.79.37 3.34 3.34 0 0 0-1.05 2.49 5.8 5.8 0 0 0 1.24 3.08 13.2 13.2 0 0 0 5.06 4.34c.72.31 1.43.6 2.18.77a5 5 0 0 0 2.28.14 3.72 3.72 0 0 0 2.44-1.72 3 3 0 0 0 .2-1.79c-.09-.16-.28-.23-.59-.38z"/></svg>
              </a>
            {% endif %}
          </td>
          <td>
            {{ a.service.title }}
            {% for s in a.sale_set.all %}
              {% if s.service and s.status == 'paid' %}
                + {{ s.service.title }}
              {% endif %}
            {% endfor %}
          </td>
          {% if is_admin %}<td>{{ a.created_at|date:'d/m H:i' }}</td>{% endif %}
          <td>
            {% if a.status == 'scheduled' %}
              <span class="badge rounded-pill text-bg-secondary">Agendado</span>
            {% elif a.status == 'done' %}
              <span class="badge rounded-pill bg-success">Concluído</span>
            {% elif a.status == 'cancelled' %}
              <span class="badge rounded-pill bg-danger">Cancelado</span>
            {% else %}
              <span class="badge rounded-pill badge-accent">{{ a.status }}</span>
            {% endif %}
            <a href="#" class="btn btn-sm btn-outline-light ms-2 edit-appointment-btn"
               data-bs-toggle="modal"
               data-bs-target="#editAppointmentModal"
               data-appointment-id="{{ a.id }}"
               data-appointment-status="{{ a.status }}"
               data-appointment-barber-id="{{ a.barber.id }}">
              Editar
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="{% if is_admin %}8{% else %}6{% endif %}" class="text-center muted">Sem agendamentos.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>
      Página {{ appointments_page.number }} de {{ paginator.num_pages }}
    </div>
    <nav aria-label="Navegação de página">
      <ul class="pagination pagination-dark mb-0">
        {% if appointments_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ appointments_page.previous_page_number }}">Anterior</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        {% for num in appointments_page.paginator.page_range %}
          {% if num == appointments_page.number %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if appointments_page.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ appointments_page.next_page_number }}">Próxima</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Próxima</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<!-- Modal: Editar agendamento -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="editAppointmentLabel">Editar agendamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editAppointmentForm">
          <input type="hidden" name="appointment_id" id="eaAppointmentId">
          <input type="hidden" name="barber_id" id="eaBarberId">
          <div class="mb-3">
            <label class="form-label">Ação</label>
            <select class="form-select" id="eaAction" name="action" required>
              <option value="update_service">Trocar serviço do agendamento</option>
              <option value="add_sale">Adicionar serviço extra (gera venda)</option>
              <option value="register_sale">Registrar venda</option>
              <option value="mark_completed">Marcar como concluído (libera horário)</option>
              <option value="cancel">Cancelar agendamento</option>
            </select>
          </div>

          <div id="eaServiceFields" class="mb-3">
            <label class="form-label">Serviço</label>
            <select class="form-select" id="eaService" name="service_id">
              <option value="" disabled selected>Carregando...</option>
            </select>
          </div>

          <div id="eaSaleFields" class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Valor (R$)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="eaAmount" name="amount" placeholder="0,00">
            </div>
            <div class="col-md-4">
              <label class="form-label">Pagamento</label>
              <select class="form-select" id="eaPayment" name="payment_method">
                <option value="cash">Dinheiro</option>
                <option value="pix">Pix</option>
                <option value="card">Cartão</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Descrição</label>
              <input type="text" class="form-control" id="eaDescription" name="description" placeholder="Ex.: Luzes, Barba, etc">
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-accent">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>

<script>
  (function(){
    const modalEl = document.getElementById('editAppointmentModal');
    const form = document.getElementById('editAppointmentForm');
    const actionSel = document.getElementById('eaAction');
    const serviceFields = document.getElementById('eaServiceFields');
    const saleFields = document.getElementById('eaSaleFields');
    const serviceSel = document.getElementById('eaService');
    const amountInput = document.getElementById('eaAmount');
    const paymentSel = document.getElementById('eaPayment');
    const descInput = document.getElementById('eaDescription');

    function getCsrfToken(){
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : '';
    }

    function toggleFields(){
      const action = actionSel.value;
      serviceFields.style.display = (action === 'update_service' || action === 'add_sale') ? '' : 'none';
      saleFields.style.display = (action === 'add_sale' || action === 'register_sale') ? '' : 'none';
    }

    actionSel.addEventListener('change', toggleFields);

    modalEl.addEventListener('show.bs.modal', (ev) => {
      const btn = ev.relatedTarget;
      const apptId = btn?.getAttribute('data-appointment-id');
      const barberId = btn?.getAttribute('data-appointment-barber-id');
      document.getElementById('eaAppointmentId').value = apptId || '';
      document.getElementById('eaBarberId').value = barberId || '';
      // Default view fields
      actionSel.value = 'update_service';
      toggleFields();
      // Load services list
      fetch('/api/services/')
        .then(r => r.json())
        .then(data => {
          const results = Array.isArray(data) ? data : (data.results || []);
          serviceSel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          results.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.title + ' — R$ ' + (s.price || '0,00');
            opt.dataset.price = s.price || '0.00';
            serviceSel.appendChild(opt);
          });
        }).catch(() => {
          serviceSel.innerHTML = '<option disabled>Falha ao carregar serviços</option>';
        });
    });

    serviceSel.addEventListener('change', () => {
      const price = parseFloat(serviceSel.options[serviceSel.selectedIndex]?.dataset?.price || '0');
      if (!isNaN(price)) {
        amountInput.value = price.toFixed(2);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const apptId = document.getElementById('eaAppointmentId').value;
      const barberId = document.getElementById('eaBarberId').value;
      const action = actionSel.value;
      try {
        let res;
        if (action === 'cancel') {
          // Usar PATCH no recurso principal evita 404 e permite lógica de servidor
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ status: 'cancelled' })
          });
        } else if (action === 'mark_completed') {
          // Concluir antecipadamente e liberar horário ajustando fim para agora
          const now = new Date();
          const pad = (n) => n.toString().padStart(2, '0');
          const nowIso = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}:00`;
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ status: 'done', end_datetime: nowIso })
          });
        } else if (action === 'update_service') {
          const serviceId = parseInt(serviceSel.value, 10);
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ service: serviceId })
          });
        } else if (action === 'add_sale' || action === 'register_sale') {
          const payload = {
            barber: parseInt(barberId, 10),
            appointment: parseInt(apptId, 10),
            service: action === 'add_sale' ? parseInt(serviceSel.value, 10) : null,
            description: (descInput.value || '').toString(),
            amount: parseFloat(amountInput.value || '0'),
            payment_method: paymentSel.value,
            status: 'paid'
          };
          res = await fetch('/api/sales/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify(payload)
          });
        }
        if (!res || !res.ok) throw new Error('Falha ao salvar');
        // Sucesso: fechar modal e recarregar
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        window.location.reload();
      } catch (err) {
        alert('Erro ao salvar alterações.');
      }
    });
  })();
</script>
{% endblock %}