{% extends 'base.html' %}
{% load static %}
{% block title %}Agendamentos{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Agendamentos</h3>
  <div>
    <a href="#" class="btn btn-sm btn-accent" data-bs-toggle="modal" data-bs-target="#quickScheduleModal">Novo agendamento</a>
    <a href="?export=csv" class="btn btn-sm btn-outline-light ms-2">Exportar CSV</a>
  </div>
  </div>

<div class="card card-panel mb-4">
  <div class="card-header fw-semibold">Agendamentos (histórico)</div>
  <div class="card-body p-3">
    <style>
      .appt-board {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }
      .appt-col {
        background: #1d1d1d;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .appt-col-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        border-bottom: 1px solid #2a2a2a;
      }
      .appt-col-header .avatar {
        width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
        background: #333; display: inline-block;
      }
      .appt-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
      .appt-card { background: #262626; border: 1px solid #333; border-radius: 8px; padding: 10px; }
      .appt-card .time { font-weight: 600; font-size: 14px; opacity: .9; }
      .appt-card .service { font-size: 13px; opacity: .85; }
      .appt-card .client { font-size: 13px; }
      .appt-card .actions { margin-top: 8px; display: flex; gap: 8px; align-items: center; }
      .appt-status { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #444; }
      .appt-status.scheduled { background:#2b2b2b; }
      .appt-status.done { background:#173e2b; border-color:#226b4a; color:#9be7c8; }
      .appt-status.cancelled { background:#3a1d1d; border-color:#6b2222; color:#f0b6b6; }
    </style>

    {% if appointments_groups and appointments_groups|length > 0 %}
      <div class="appt-board">
        {% for group in appointments_groups %}
          <div class="appt-col">
            <div class="appt-col-header">
              {% if group.barber.avatar %}
                <img src="{{ group.barber.avatar.url }}" alt="avatar" class="avatar" />
              {% else %}
                {% with name=group.barber.display_name|default:group.barber.username %}
                  {% if name|lower == 'kaue' %}
                    <img src="{% static 'assets/img/kaue.jpg' %}" alt="Kaue" class="avatar" />
                  {% elif name|lower == 'kevin' %}
                    <img src="{% static 'assets/img/kevin.JPEG' %}" alt="Kevin" class="avatar" />
                  {% elif name|lower == 'emerson' %}
                    <img src="{% static 'assets/img/emerson.JPG' %}" alt="Emerson" class="avatar" />
                  {% elif name|lower == 'rikelv' %}
                    <img src="{% static 'assets/img/rikelv.JPEG' %}" alt="Rikelv" class="avatar" />
                  {% elif name|lower == 'alefi' or name|lower == 'alafy' %}
                    <img src="{% static 'assets/img/alafy.JPEG' %}" alt="Alafy" class="avatar" />
                  {% else %}
                    <span class="avatar d-inline-flex justify-content-center align-items-center"><span class="small">{{ name|first }}</span></span>
                  {% endif %}
                {% endwith %}
              {% endif %}
              <div class="fw-semibold">{{ group.barber.display_name|default:group.barber.username }}</div>
            </div>
            <div class="appt-list">
              {% for a in group.list %}
                <div class="appt-card">
                  <div class="time">{{ a.start_datetime|date:'d/m/Y' }} - {{ a.start_datetime|date:'H:i' }} até {{ a.end_datetime|date:'H:i' }}</div>
                  <div class="client">{{ a.client_name }}{% if a.client_phone %} • {{ a.client_phone }}{% endif %}</div>
                  <div class="service">{{ a.service.title }}
                    {% for s in a.sale_set.all %}
                      {% if s.service and s.status == 'paid' %} + {{ s.service.title }}{% endif %}
                    {% endfor %}
                  </div>
                  <div class="actions">
                    {% if a.status == 'scheduled' %}
                      <span class="appt-status scheduled">Agendado</span>
                    {% elif a.status == 'done' %}
                      <span class="appt-status done">Concluído</span>
                    {% elif a.status == 'cancelled' %}
                      <span class="appt-status cancelled">Cancelado</span>
                    {% else %}
                      <span class="appt-status">{{ a.status }}</span>
                    {% endif %}
                    {% if a.client_phone %}
                      <a href="https://wa.me/{{ a.client_phone }}" target="_blank" class="text-decoration-none" title="WhatsApp">
                        <img src="{% static 'assets/img/whatsapp.png' %}" alt="WhatsApp" width="18" height="18" />
                      </a>
                    {% endif %}
                    <a href="#" class="btn btn-sm btn-outline-light edit-appointment-btn"
                       data-bs-toggle="modal"
                       data-bs-target="#editAppointmentModal"
                       data-appointment-id="{{ a.id }}"
                       data-appointment-status="{{ a.status }}"
                       data-appointment-barber-id="{{ a.barber.id }}">Editar</a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-4 muted">Sem agendamentos.</div>
    {% endif %}
  </div>
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>
      Página {{ appointments_page.number }} de {{ paginator.num_pages }}
    </div>
    <nav aria-label="Navegação de página">
      <ul class="pagination pagination-dark mb-0">
        {% if appointments_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ appointments_page.previous_page_number }}">Anterior</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        {% for num in appointments_page.paginator.page_range %}
          {% if num == appointments_page.number %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if appointments_page.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ appointments_page.next_page_number }}">Próxima</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Próxima</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<!-- Modal: Editar agendamento -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="editAppointmentLabel">Editar agendamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editAppointmentForm">
          <input type="hidden" name="appointment_id" id="eaAppointmentId">
          <input type="hidden" name="barber_id" id="eaBarberId">
          <div class="mb-3">
            <label class="form-label">Ação</label>
            <select class="form-select" id="eaAction" name="action" required>
              <option value="update_service">Trocar serviço do agendamento</option>
              <option value="add_sale">Adicionar serviço extra (gera venda)</option>
              <option value="register_sale">Registrar venda</option>
              <option value="mark_completed">Marcar como concluído (libera horário)</option>
              <option value="cancel">Cancelar agendamento</option>
            </select>
          </div>

          <div id="eaServiceFields" class="mb-3">
            <label class="form-label">Serviço</label>
            <select class="form-select" id="eaService" name="service_id">
              <option value="" disabled selected>Carregando...</option>
            </select>
          </div>

          <div id="eaSaleFields" class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Valor (R$)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="eaAmount" name="amount" placeholder="0,00">
            </div>
            <div class="col-md-4">
              <label class="form-label">Pagamento</label>
              <select class="form-select" id="eaPayment" name="payment_method">
                <option value="cash">Dinheiro</option>
                <option value="pix">Pix</option>
                <option value="card">Cartão</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Descrição</label>
              <input type="text" class="form-control" id="eaDescription" name="description" placeholder="Ex.: Luzes, Barba, etc">
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-accent">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>

<script>
  (function(){
    const modalEl = document.getElementById('editAppointmentModal');
    const form = document.getElementById('editAppointmentForm');
    const actionSel = document.getElementById('eaAction');
    const serviceFields = document.getElementById('eaServiceFields');
    const saleFields = document.getElementById('eaSaleFields');
    const serviceSel = document.getElementById('eaService');
    const amountInput = document.getElementById('eaAmount');
    const paymentSel = document.getElementById('eaPayment');
    const descInput = document.getElementById('eaDescription');

    function getCsrfToken(){
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : '';
    }

    function toggleFields(){
      const action = actionSel.value;
      serviceFields.style.display = (action === 'update_service' || action === 'add_sale') ? '' : 'none';
      saleFields.style.display = (action === 'add_sale' || action === 'register_sale') ? '' : 'none';
    }

    actionSel.addEventListener('change', toggleFields);

    modalEl.addEventListener('show.bs.modal', (ev) => {
      const btn = ev.relatedTarget;
      const apptId = btn?.getAttribute('data-appointment-id');
      const barberId = btn?.getAttribute('data-appointment-barber-id');
      document.getElementById('eaAppointmentId').value = apptId || '';
      document.getElementById('eaBarberId').value = barberId || '';
      // Default view fields
      actionSel.value = 'update_service';
      toggleFields();
      // Load services list
      fetch('/api/services/')
        .then(r => r.json())
        .then(data => {
          const results = Array.isArray(data) ? data : (data.results || []);
          serviceSel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          results.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.title + ' — R$ ' + (s.price || '0,00');
            opt.dataset.price = s.price || '0.00';
            serviceSel.appendChild(opt);
          });
        }).catch(() => {
          serviceSel.innerHTML = '<option disabled>Falha ao carregar serviços</option>';
        });
    });

    serviceSel.addEventListener('change', () => {
      const price = parseFloat(serviceSel.options[serviceSel.selectedIndex]?.dataset?.price || '0');
      if (!isNaN(price)) {
        amountInput.value = price.toFixed(2);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const apptId = document.getElementById('eaAppointmentId').value;
      const barberId = document.getElementById('eaBarberId').value;
      const action = actionSel.value;
      try {
        let res;
        if (action === 'cancel') {
          // Usar PATCH no recurso principal evita 404 e permite lógica de servidor
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ status: 'cancelled' })
          });
        } else if (action === 'mark_completed') {
          // Concluir antecipadamente e liberar horário ajustando fim para agora
          const now = new Date();
          const pad = (n) => n.toString().padStart(2, '0');
          const nowIso = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}:00`;
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ status: 'done', end_datetime: nowIso })
          });
        } else if (action === 'update_service') {
          const serviceId = parseInt(serviceSel.value, 10);
          res = await fetch(`/api/appointments/${apptId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ service: serviceId })
          });
        } else if (action === 'add_sale' || action === 'register_sale') {
          const payload = {
            barber: parseInt(barberId, 10),
            appointment: parseInt(apptId, 10),
            service: action === 'add_sale' ? parseInt(serviceSel.value, 10) : null,
            description: (descInput.value || '').toString(),
            amount: parseFloat(amountInput.value || '0'),
            payment_method: paymentSel.value,
            status: 'paid'
          };
          res = await fetch('/api/sales/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify(payload)
          });
        }
        if (!res || !res.ok) throw new Error('Falha ao salvar');
        // Sucesso: fechar modal e recarregar
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        window.location.reload();
      } catch (err) {
        alert('Erro ao salvar alterações.');
      }
    });
  })();
</script>
{% endblock %}