{% extends 'base.html' %}
{% block title %}Finanças{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Finanças</h3>
  <div>
    <a href="?export=csv" class="btn btn-sm btn-accent d-inline-flex align-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
        <path d="M.5 9.9a.5.5 0 0 1 .5-.5h3.5V1.5a.5.5 0 0 1 1 0v7.9H9a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 3.5 9.4H1a.5.5 0 0 1-.5-.5Z"/>
        <path d="M.5 15a.5.5 0 0 0 .5.5h14a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-1 0v2.5H1V12a.5.5 0 0 0-1 0v3Z"/>
      </svg>
      Exportar CSV (mês)
    </a>
    {% if can_withdraw %}
    <button type="button" class="btn btn-sm btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
      Retirada
    </button>
    {% endif %}
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.today_revenue }}</div>
        <div class="kpi-label">Faturamento Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.month_revenue }}</div>
        <div class="kpi-label">Faturamento no Mês</div>
      </div>
    </div>
  </div>
  
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">{{ kpis.appts_completed }}</div>
        <div class="kpi-label">Concluídos Hoje</div>
      </div>
    </div>
  </div>
  {% if not is_admin %}
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.barber_share_month }}</div>
        <div class="kpi-label">Participação de Serviços (Mês)</div>
      </div>
    </div>
  </div>
  {% if is_special_finances_view %}
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.month_total_all }}</div>
        <div class="kpi-label">Faturamento Total (Mês)</div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endif %}
</div>

{% if can_withdraw %}
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="withdrawModalLabel">Registrar retirada de caixa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="number" step="0.01" min="0" class="form-control bg-dark text-light border-secondary" id="withdrawAmount" name="withdraw_amount" placeholder="0,00" required>
            <label for="withdrawAmount">Valor (R$)</label>
          </div>
          <div class="form-floating">
            <textarea class="form-control bg-dark text-light border-secondary" placeholder="Observação (opcional)" id="withdrawNote" name="withdraw_note" style="height: 100px"></textarea>
            <label for="withdrawNote">Observação (opcional)</label>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Confirmar retirada</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Resumo por serviço (mês, concluídos)</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Serviço</th>
              <th style="width: 120px;">Qtd</th>
              <th style="width: 160px;">Valor total</th>
            </tr>
          </thead>
          <tbody>
            {% for row in breakdown_by_service %}
            <tr>
              <td>{{ row.service__title }}</td>
              <td>{{ row.count }}</td>
              <td>R$ {{ row.total_value }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center muted">Sem registros nesse período.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Todos os serviços</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Serviço</th>
              <th style="width: 120px;">Tempo</th>
              <th style="width: 160px;">Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for s in all_services %}
            <tr>
              <td>{{ s.title }}</td>
              <td>{% if s.duration_minutes %}{{ s.duration_minutes }} min{% endif %}</td>
              <td>R$ {{ s.price }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center muted">Nenhum serviço cadastrado.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if is_admin %}
<div class="row g-3">
  <div class="col-12">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Resumo por barbeiro (mês, concluídos)</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Barbeiro</th>
              <th style="width: 120px;">Qtd</th>
              <th style="width: 160px;">Valor total</th>
            </tr>
          </thead>
          <tbody>
            {% for row in breakdown_by_barber %}
            <tr>
              <td>
                {% with display=row.barber__display_name username=row.barber__username %}
                  {% if display %}{{ display }}{% else %}{{ username }}{% endif %}
                {% endwith %}
              </td>
              <td>{{ row.count }}</td>
              <td>R$ {{ row.total_value }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center muted">Sem registros nesse período.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-12">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Concluídos hoje</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th style="width: 140px;">Data</th>
              <th style="width: 80px;">Hora</th>
              {% if is_admin %}<th>Barbeiro</th>{% endif %}
              <th>Cliente</th>
              <th>Serviço</th>
            </tr>
          </thead>
          <tbody>
            {% for a in completed_today %}
            <tr>
              <td>{{ a.start_datetime|date:'d/m/Y' }}</td>
              <td>{{ a.start_datetime|date:'H:i' }}</td>
              {% if is_admin %}
              <td>
                {% if a.barber.avatar %}
                  <img src="{{ a.barber.avatar.url }}" alt="avatar" class="rounded-circle me-2" style="width:24px;height:24px;object-fit:cover;">
                {% endif %}
                {{ a.barber.display_name|default:a.barber.username }}
              </td>
              {% endif %}
              <td>{{ a.client_name }}</td>
              <td>{{ a.service.title }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center muted">Sem concluídos hoje.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}