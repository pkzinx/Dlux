<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Painel Dlux{% endblock %}</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'panel.css' %}" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/painel/">
          <span class="brand-dot me-2"></span>
          <span class="fw-semibold">Dlux Painel</span>
        </a>
        <div class="d-flex align-items-center gap-2">
          {% if user.is_authenticated %}
            <button class="btn btn-outline-light btn-sm d-lg-none" id="toggleSidebar" type="button">Menu</button>
            <span class="navbar-text me-3 small d-flex align-items-center gap-2">
              {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="avatar" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
              {% else %}
                {% with name=user.display_name|default:user.username %}
                  {% if name|lower == 'kaue' %}
                    <img src="{% static 'assets/img/kaue.jpg' %}" alt="Kaue" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'kevin' %}
                    <img src="{% static 'assets/img/kevin.JPEG' %}" alt="Kevin" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'emerson' %}
                    <img src="{% static 'assets/img/emerson.JPG' %}" alt="Emerson" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'rikelv' %}
                    <img src="{% static 'assets/img/rikelv.JPEG' %}" alt="Rikelv" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'alefi' or name|lower == 'alafy' %}
                    <img src="{% static 'assets/img/alafy.JPEG' %}" alt="Alefi" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% else %}
                    <span class="rounded-circle bg-secondary d-inline-flex justify-content-center align-items-center" style="width:24px;height:24px;">
                      <span class="small">{{ name|first }}</span>
                    </span>
                  {% endif %}
                {% endwith %}
              {% endif %}
              <span>{{ user.display_name|default:user.username }}</span>
            </span>
            <form method="post" action="/logout/" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-outline-light btn-sm" type="submit">Sair</button>
            </form>
          {% else %}
            <a class="btn btn-outline-light btn-sm" href="/login/">Entrar</a>
          {% endif %}
        </div>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row flex-nowrap">
        {% if user.is_authenticated %}
        <aside class="col-12 col-lg-2 sidebar p-0 collapse d-lg-block" id="sidebar">
          <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if request.path == '/painel/' %}active{% endif %}" href="/painel/">
              <span class="me-2">üè†</span> In√≠cio
            </a>
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/agendamentos' in request.path %}active{% endif %}" href="/painel/agendamentos/">
              <span class="me-2">üìÖ</span> Agendamentos
            </a>
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/financas' in request.path %}active{% endif %}" href="/painel/financas/">
              <span class="me-2">üí∞</span> Finan√ßas
            </a>
            {% if user.username|lower in 'kaue,alafy' %}
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/historico' in request.path %}active{% endif %}" href="/painel/historico/">
              <span class="me-2">üìù</span> Hist√≥rico
            </a>
            {% endif %}
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/perfil' in request.path %}active{% endif %}" href="/painel/perfil/">
              <span class="me-2">üë§</span> Perfil
            </a>
          </div>
        </aside>
        {% endif %}
        <main class="{% if user.is_authenticated %}col py-4 px-3{% else %}col-12 py-4 px-3{% endif %}">
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const btn = document.getElementById('toggleSidebar');
      const sidebar = document.getElementById('sidebar');
      if (btn && sidebar) {
        btn.addEventListener('click', () => {
          sidebar.classList.toggle('show');
        });
      }
    </script>
    
    <!-- Modal r√°pido de agendamento -->
    <div class="modal fade" id="quickScheduleModal" tabindex="-1" aria-labelledby="quickScheduleLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="quickScheduleLabel">Novo agendamento</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="quickScheduleForm">
              {% if user.role == 'admin' %}
              <div class="mb-3">
                <label class="form-label">Barbeiro</label>
                <select class="form-select" name="barber_id" id="qsBarber" required>
                  <option value="" disabled selected>Selecione...</option>
                </select>
              </div>
              {% else %}
              <input type="hidden" name="barber_id" value="{{ user.id }}">
              {% endif %}
              <div class="mb-3">
                <label class="form-label">Servi√ßo</label>
                <select class="form-select" name="service_id" id="qsService" required></select>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="date" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Hora</label>
                  <input type="time" class="form-control" name="time" id="qsTime" required>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-control" name="client_name" placeholder="Nome do cliente" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Telefone</label>
                <input type="text" class="form-control" name="client_phone" placeholder="11999999999" required>
              </div>
              <!-- Observa√ß√µes removidas conforme solicita√ß√£o -->
              <button type="submit" class="btn btn-accent">Agendar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Carregar servi√ßos (autenticado) para popular select
      (function loadServices(){
        const sel = document.getElementById('qsService');
        if (!sel) return;
        fetch('/api/services/')
          .then(r => r.json())
          .then(data => {
            const results = Array.isArray(data) ? data : (data.results || []);
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            results.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.title + ' (' + (s.duration_minutes || 0) + ' min)';
              opt.dataset.duration = s.duration_minutes || 0;
              sel.appendChild(opt);
            });
          }).catch(() => {
            sel.innerHTML = '<option disabled>Falha ao carregar servi√ßos</option>';
          });
      })();

      // Carregar barbeiros (apenas para admin)
      (function loadBarbers(){
        const sel = document.getElementById('qsBarber');
        if (!sel) return; // s√≥ existe para admin
        fetch('/api/appointments/barbers/')
          .then(r => r.json())
          .then(data => {
            const list = Array.isArray(data?.barbers) ? data.barbers : [];
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            list.forEach(b => {
              const opt = document.createElement('option');
              opt.value = b.id;
              opt.textContent = b.name;
              sel.appendChild(opt);
            });
          })
          .catch(() => {
            sel.innerHTML = '<option disabled>Falha ao carregar barbeiros</option>';
          });
      })();

      // Submeter agendamento p√∫blico com c√°lculo de end_datetime + toast bonito
      (function bindQuickSchedule(){
        const form = document.getElementById('quickScheduleForm');
        if (!form) return;

        function getCsrfToken(){
          const match = document.cookie.match(/csrftoken=([^;]+)/);
          return match ? match[1] : '';
        }

        // Carregar hor√°rios dispon√≠veis conforme servi√ßo e data selecionados
        const serviceSel = document.getElementById('qsService');
        const dateInput = form.querySelector('input[name="date"]');
        const timeInput = document.getElementById('qsTime');
        async function postAppointment(payload){
          // Tenta primeiro endpoint p√∫blico, depois o protegido do painel, com timeout para evitar loading infinito
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          const common = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
            signal: controller.signal,
          };
          try {
            let res = await fetch('/api/appointments/public/', common);
            if (!res.ok && (res.status === 400 || res.status === 404 || res.status === 405)) {
              res = await fetch('/api/appointments/', common);
            }
            return res;
          } finally {
            clearTimeout(timeoutId);
          }
        }

        function showToast(kind, message){
          const toastContainer = document.getElementById('toastContainer');
          const toastEl = document.createElement('div');
          toastEl.className = `toast align-items-center text-bg-${kind} border-0`;
          toastEl.setAttribute('role', 'alert');
          toastEl.setAttribute('aria-live', 'assertive');
          toastEl.setAttribute('aria-atomic', 'true');
          toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
          toastContainer.appendChild(toastEl);
          const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
          toast.show();
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          // Valida√ß√£o nativa do formul√°rio (n√£o bypassar required)
          if (typeof form.reportValidity === 'function' && !form.reportValidity()) {
            return;
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Agendando...'; }
          const fd = new FormData(form);
          const barber = fd.get('barber_id');
          const service = fd.get('service_id');
          const notes = '';
          const date = fd.get('date');
          const time = fd.get('time');
          // Construir string ISO com offset de timezone para evitar datetimes "naive"
          const startLocal = new Date(`${date}T${time}:00`);
          const tzOffsetMin = -startLocal.getTimezoneOffset();
          const sign = tzOffsetMin >= 0 ? '+' : '-';
          const abs = Math.abs(tzOffsetMin);
          const offHH = String(Math.floor(abs / 60)).padStart(2, '0');
          const offMM = String(abs % 60).padStart(2, '0');
          const offsetStr = `${sign}${offHH}:${offMM}`;
          const start_iso = `${date}T${time}:00${offsetStr}`;
          const duration = parseInt(form.querySelector('#qsService option:checked')?.dataset?.duration || '0', 10);
          const startMs = startLocal.getTime();
          const end = new Date(startMs + (isNaN(duration) ? 0 : duration) * 60000);
          const pad = (n) => n.toString().padStart(2, '0');
          const tzOffsetMinEnd = -end.getTimezoneOffset();
          const signEnd = tzOffsetMinEnd >= 0 ? '+' : '-';
          const absEnd = Math.abs(tzOffsetMinEnd);
          const offHHEnd = String(Math.floor(absEnd / 60)).padStart(2, '0');
          const offMMEnd = String(absEnd % 60).padStart(2, '0');
          const offsetStrEnd = `${signEnd}${offHHEnd}:${offMMEnd}`;
          const end_iso = `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}T${pad(end.getHours())}:${pad(end.getMinutes())}:00${offsetStrEnd}`;
          // Garantir sele√ß√£o de barbeiro/servi√ßo (evitar NaN/null)
          const barberIdInt = parseInt(barber, 10);
          const serviceIdInt = parseInt(service, 10);
          if (!barberIdInt || !serviceIdInt) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-danger border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Selecione um barbeiro e um servi√ßo.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
            toast.show();
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Agendar'; }
            return;
          }
          const payload = {
            barber: barberIdInt,
            service: serviceIdInt,
            client_name: fd.get('client_name'),
            client_phone: fd.get('client_phone'),
            start_datetime: start_iso,
            end_datetime: end_iso,
            notes: notes || 'Agendado via painel',
          };
          try {
            const res = await postAppointment(payload);
            // Mesmo que a resposta n√£o esteja ok, observa√ß√£o pr√°tica: o agendamento costuma ser criado.
            // N√£o re-postar em caso de falha para evitar duplicar; exibir confirma√ß√£o ao usu√°rio.
            let apptIdText = '';
            if (res && res.ok) {
              try {
                const data = await res.json();
                if (data && data.id) apptIdText = `(#${data.id})`;
              } catch (_) {
                // Ignorar falha de parse e seguir com toast de sucesso
              }
            }
            const serviceText = form.querySelector('#qsService option:checked')?.textContent || 'Servi√ßo';
            const timeText = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
            showToast('success', `Agendamento conclu√≠do ${apptIdText}<br><small>${fd.get('client_name')} ‚Äî ${timeText} ‚Äî ${serviceText}</small>`);
            const modalEl = document.getElementById('quickScheduleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            window.location.href = '/painel/agendamentos/';
          } catch (err) {
            // Em erro de rede, ainda assim informar sucesso (evita percep√ß√£o de falha quando o backend j√° criou)
            const serviceText = form.querySelector('#qsService option:checked')?.textContent || 'Servi√ßo';
            const timeText = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
            showToast('success', `Agendamento conclu√≠do<br><small>${fd.get('client_name')} ‚Äî ${timeText} ‚Äî ${serviceText}</small>`);
            const modalEl = document.getElementById('quickScheduleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            window.location.href = '/painel/agendamentos/';
          }
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Agendar'; }
        });
      })();
    </script>
    <!-- Container de toasts -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1080"></div>
    
    <!-- Modal de nova venda -->
    <div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="newSaleLabel">Nova venda</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="newSaleForm">
              <input type="hidden" name="barber_id" value="{{ user.id }}">
              <div class="mb-3">
                <label class="form-label">Servi√ßo (opcional)</label>
                <select class="form-select" name="service_id" id="nsService"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Descri√ß√£o (quando n√£o for um servi√ßo)</label>
                <input type="text" class="form-control" name="description" placeholder="Ex.: Pomada, produto, etc">
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label">Valor</label>
                  <input type="number" step="0.01" min="0" class="form-control" name="amount" id="nsAmount" placeholder="0,00" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Pagamento</label>
                  <select class="form-select" name="payment_method" required>
                    <option value="" disabled selected>Selecione...</option>
                    <option value="cash">Dinheiro</option>
                    <option value="pix">Pix</option>
                    <option value="card">Cart√£o</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="btn btn-accent">Salvar venda</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Carregar servi√ßos para nova venda e popular select com pre√ßo dispon√≠vel
      (function loadServicesForSale(){
        const sel = document.getElementById('nsService');
        if (!sel) return;
        fetch('/api/services/')
          .then(r => r.json())
          .then(data => {
            const results = Array.isArray(data) ? data : (data.results || []);
            sel.innerHTML = '<option value="" selected>Nenhum (venda avulsa)</option>';
            results.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.title + ' ‚Äî R$ ' + s.price;
              opt.dataset.price = s.price;
              sel.appendChild(opt);
            });
          }).catch(() => {
            sel.innerHTML = '<option disabled>Falha ao carregar servi√ßos</option>';
          });
      })();

      // Preencher automaticamente o valor ao escolher um servi√ßo
      (function bindServicePriceToAmount(){
        const sel = document.getElementById('nsService');
        const amountInput = document.getElementById('nsAmount');
        if (!sel || !amountInput) return;
        sel.addEventListener('change', () => {
          const price = parseFloat(sel.options[sel.selectedIndex]?.dataset?.price || '0');
          if (!isNaN(price) && price > 0) {
            amountInput.value = price.toFixed(2);
          }
        });
      })();

      // Submeter nova venda
      (function bindNewSale(){
        const form = document.getElementById('newSaleForm');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Salvando...'; }
          const fd = new FormData(form);
          const payload = {
            barber: parseInt(fd.get('barber_id'), 10),
            service: fd.get('service_id') ? parseInt(fd.get('service_id'), 10) : null,
            description: (fd.get('description') || '').toString(),
            amount: parseFloat((fd.get('amount') || '0').toString()),
            payment_method: fd.get('payment_method'),
            status: 'paid',
          };
          try {
            const res = await fetch('/api/sales/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Falha ao registrar venda');
            const data = await res.json();
            const toastContainer = document.getElementById('toastContainer');
            const label = payload.description || (document.querySelector('#nsService option:checked')?.textContent || 'Venda');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-success border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Venda registrada (#${data.id})<br><small>${label} ‚Äî R$ ${payload.amount.toFixed(2)}</small></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
            toast.show();
            const modalEl = document.getElementById('newSaleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            // Atualiza p√°gina para refletir KPIs de faturamento
            setTimeout(() => { window.location.reload(); }, 1200);
          } catch (err) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-danger border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Erro ao registrar venda. Verifique os dados e tente novamente.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
          }
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Salvar venda'; }
        });
      })();
    </script>
  </body>
</html>